{% extends "base.html" %}
{% block content %}

{% if not recalc_success %}
<div class="card" style="background-color: #ff6b6b; border-left: 5px solid #e74c3c; color: white;">
    <div style="display:flex; align-items:center;">
        <div style="margin-right:15px;">
            <!-- –ò–∫–æ–Ω–∫–∞ alert, –µ—Å–ª–∏ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫–∞–∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—Å—É—Ä—Å -->
            ‚ö†Ô∏è
        </div>
        <div>
            <div style="font-weight:bold; margin-bottom:5px;">‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –¢–ê–ë–õ–ò–¶–ê –û–¢–ö–†–´–¢–ê! ‚ö†Ô∏è</div>
            <div>
                –ü–µ—Ä–µ—Ä–∞—Å—á—ë—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.<br>
                –ó–∞–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—á—ë—Ç—ã.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if serviced_status == "success" %}
<div class="card" style="background-color: #18bc9c; border-left: 5px solid #16a085; color: white;">
    <div style="display:flex; align-items:center;">
        <div style="margin-right:15px; font-size:32px;">‚úÖ</div>
        <div>
            <div style="font-weight:bold; margin-bottom:5px;">‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Å–ª—É–∂–µ–Ω–æ!</div>
            <div>{{ serviced_message }}</div>
        </div>
    </div>
</div>
{% elif serviced_status == "error" %}
<div class="card" style="background-color: #ff6b6b; border-left: 5px solid #e74c3c; color: white;">
    <div style="display:flex; align-items:center;">
        <div style="margin-right:15px; font-size:32px;">‚ùå</div>
        <div>
            <div style="font-weight:bold; margin-bottom:5px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏</div>
            <div>{{ serviced_message }}</div>
        </div>
    </div>
</div>
{% endif %}

<div class="card" style="background-color: #2c3e50; border-left: 4px solid #18bc9c; color: white;">
    <div style="display:flex; flex-wrap:wrap; align-items:center;">
        <div style="margin-right:20px;">
            <img src="{{ url_for('static', filename='manky.png') }}" alt="–ò–∫–æ–Ω–∫–∞" style="width:64px; height:64px; border-radius:8px;">
        </div>
        <div style="display:flex; flex-wrap:wrap; justify-content:space-around; text-align:center; align-items:center; flex:1;">
            <div style="margin:5px;">
                <div style="font-size:14px; color:#ffd6d6; margin-bottom:3px;">üö® –û–ë–°–õ–£–ñ–ò–¢–¨</div>
                <div style="font-size:28px; font-weight:bold; color:#ff6b6b;">
                    {{ filtered_urgent_count }} / {{ total_urgent }}
                </div>
            </div>
            <div style="margin:5px 0 5px 20px;">
                <div style="font-size:14px; color:#ffe082; margin-bottom:3px;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ</div>
                <div style="font-size:28px; font-weight:bold; color:#ffd54f;">
                    {{ filtered_warning_count }} / {{ total_warning }}
                </div>
            </div>
            <div style="margin:5px 0 5px 20px;">
                <div style="font-size:14px; color:#18bc9c; margin-bottom:3px;">‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</div>
                <div style="font-size:28px; font-weight:bold; color:#18bc9c;">
                    {{ status_counts[config.STATUS_OK] }}
                </div>
            </div>
            <div style="margin:5px 0 5px 20px;">
                <div style="font-size:14px; color:#bbdefb; margin-bottom:3px;">üìä –í—Å–µ–≥–æ</div>
                <div style="font-size:28px; font-weight:bold; color:#4fc3f7;">
                    {{ total_records }}
                </div>
            </div>
        </div>
        <div style="margin-left:20px;">
            <a href="{{ url_for('download_excel') }}" title="–°–∫–∞—á–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É">
                <img src="{{ url_for('static', filename='excel.png') }}" alt="Excel" style="width:52px; height:52px; border-radius:6px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            </a>
        </div>
    </div>
</div>

<div class="card">
    <div style="margin-top:10px;">
        <img id="chart-image" src="{{ url_for('chart_png') }}?offset={{ chart_offset }}" alt="–î–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ç–∞—Ç—É—Å–æ–≤" style="max-width:100%; border-radius:6px;">
        <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <button type="button" id="prev-week-btn" class="btn btn-primary" style="padding:6px 12px;" title="–ù–∞–∑–∞–¥ –Ω–∞ 7 –¥–Ω–µ–π">‚óÄ -7–¥</button>
                <!-- <label for="chart_date" style="font-size:13px; color:#2c3e50; font-weight:bold;">–î–∞—Ç–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã:</label> -->
                <input type="date" name="chart_date" id="chart_date" value="{{ chart_date }}" style="padding:6px 10px; border-radius:4px; border:1px solid #cfd8dc; font-size:13px;">
                <button type="button" id="next-week-btn" class="btn btn-primary" style="padding:6px 12px;" title="–í–ø–µ—Ä—ë–¥ –Ω–∞ 7 –¥–Ω–µ–π">+7–¥ ‚ñ∂</button>
                <button type="button" id="today-chart-btn" class="btn btn-primary" style="padding:6px 12px;">üìÖ –°–µ–≥–æ–¥–Ω—è</button>
            </div>
        </div>
    </div>
</div>

<script>
// Dynamic chart reloading without page refresh
(function() {
    const chartImage = document.getElementById('chart-image');
    const chartDateInput = document.getElementById('chart_date');
    const todayBtn = document.getElementById('today-chart-btn');
    const prevWeekBtn = document.getElementById('prev-week-btn');
    const nextWeekBtn = document.getElementById('next-week-btn');
    
    function calculateOffset(dateStr) {
        if (!dateStr) return 0;
        const selectedDate = new Date(dateStr);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        selectedDate.setHours(0, 0, 0, 0);
        const diffTime = selectedDate - today;
        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }
    
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return year + '-' + month + '-' + day;
    }
    
    function updateChart(dateStr) {
        const offset = calculateOffset(dateStr);
        // Add timestamp to force image reload
        const timestamp = new Date().getTime();
        chartImage.src = "{{ url_for('chart_png') }}?offset=" + offset + "&t=" + timestamp;
    }
    
    function adjustDate(daysToAdd) {
        const currentDate = chartDateInput.value ? new Date(chartDateInput.value) : new Date();
        currentDate.setDate(currentDate.getDate() + daysToAdd);
        
        // Don't allow future dates beyond today
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        currentDate.setHours(0, 0, 0, 0);
        
        if (currentDate > today) {
            currentDate.setTime(today.getTime());
        }
        
        const newDateStr = formatDate(currentDate);
        chartDateInput.value = newDateStr;
        updateChart(newDateStr);
    }
    
    // Initialize: if date picker shows a past date, update to today and reload chart
    function initializeToToday() {
        const currentValue = chartDateInput.value;
        const today = new Date();
        const todayStr = formatDate(today);
        
        if (currentValue !== todayStr) {
            chartDateInput.value = todayStr;
            updateChart(todayStr);
        }
    }
    
    // Run initialization on page load
    initializeToToday();
    
    todayBtn.addEventListener('click', function() {
        const today = new Date();
        const todayStr = formatDate(today);
        chartDateInput.value = todayStr;
        updateChart(todayStr);
    });
    
    prevWeekBtn.addEventListener('click', function() {
        adjustDate(-7);
    });
    
    nextWeekBtn.addEventListener('click', function() {
        adjustDate(7);
    });
    
    // Allow Enter key to rebuild chart
    chartDateInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            updateChart(chartDateInput.value);
        }
    });
    
    // Automatically rebuild chart when date is changed
    chartDateInput.addEventListener('change', function() {
        updateChart(chartDateInput.value);
    });
})();
</script>

<div class="card">
    {% if email_status == "sent" %}
        <div class="status-banner status-banner-ok">
            –ü–∏—Å—å–º–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º.
        </div>
    {% elif email_status == "error" %}
        <div class="status-banner status-banner-error">
            –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∏—Å—å–º–∞. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º. –≤ –ª–æ–≥–µ.
        </div>
    {% elif email_status == "no_items" %}
        <div class="status-banner status-banner-info">
            –ù–µ—Ç —Å—Ä–æ—á–Ω—ã—Ö –∏–ª–∏ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞.
        </div>
    {% endif %}

    <div class="filters-row">
        <form method="get" action="{{ url_for('dashboard') }}" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
            <div>
                <label for="object" style="font-size:13px; margin-right:4px;">–û–±—ä–µ–∫—Ç:</label>
                <select name="object" id="object">
                    <option value="all" {% if object_filter == "all" %}selected{% endif %}>–í—Å–µ</option>
                    {% for obj in unique_objects %}
                        <option value="{{ obj }}" {% if object_filter == obj %}selected{% endif %}>{{ obj }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="status" style="font-size:13px; margin-right:4px;">–°—Ç–∞—Ç—É—Å:</label>
                <select name="status" id="status">
                    <option value="all" {% if status_filter == "all" %}selected{% endif %}>–í—Å–µ</option>
                    <option value="urgent" {% if status_filter == "urgent" %}selected{% endif %}>–û–ë–°–õ–£–ñ–ò–¢–¨</option>
                    <option value="warning" {% if status_filter == "warning" %}selected{% endif %}>–í–Ω–∏–º–∞–Ω–∏–µ</option>
                </select>
            </div>
            <div>
                <label for="designation" style="font-size:13px; margin-right:4px;">–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ:</label>
                <input type="text" name="designation" id="designation" value="{{ designation_filter }}" placeholder="–ü–æ–∏—Å–∫..." style="padding:4px 8px; border-radius:4px; border:1px solid #cfd8dc; font-size:13px; width:150px;">
            </div>
            <div>
                <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            </div>
        </form>

        <form method="post" action="{{ url_for('send_email') }}" style="margin-left:auto;">
            <button type="submit" class="btn btn-danger">
                üîî –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ
            </button>
        </form>
    </div>
</div>

<div class="card">
    {% if urgent_items %}
        <div class="section-title" style="color:#e74c3c;">
            üö® –û–ë–°–õ–£–ñ–ò–¢–¨ (–∑–∞–ø–∏—Å–µ–π: {{ urgent_items|length }} –∏–∑ {{ total_urgent }})
        </div>
        <hr class="section-separator" style="background-color:#e74c3c;">
        {% for item in urgent_items %}
            <div style="background-color: {{ loop.cycle('#F9FCFF', '#ffffff') }}; margin-left:0; padding:10px 10px 10px 10px; position:relative;">
                {{ item.html|safe }}
                <div style="position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" class="equipment-checkbox urgent-checkbox" 
                           data-sheet="{{ item.type }}" 
                           data-row-number="{{ item.row_number }}" 
                           style="width:18px; height:18px; cursor:pointer; accent-color: #e74c3c;"
                           title="–í—ã–±—Ä–∞—Ç—å –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏">
                    <form method="post" action="{{ url_for('mark_serviced') }}" style="margin:0;" onsubmit="return confirm('–û—Ç–º–µ—Ç–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ¬´{{ item.designation }}¬ª –∫–∞–∫ –æ–±—Å–ª—É–∂–µ–Ω–Ω–æ–µ?');">
                        <input type="hidden" name="sheet_name" value="{{ item.type }}">
                        <input type="hidden" name="row_number" value="{{ item.row_number }}">
                        <input type="hidden" name="object" value="{{ object_filter }}">
                        <input type="hidden" name="status" value="{{ status_filter }}">
                        <input type="hidden" name="designation_filter" value="{{ designation_filter }}">
                        <button type="submit" class="btn btn-primary" style="padding:4px 12px; font-size:12px; background-color:#18bc9c; border:none;">‚úÖ –û–±—Å–ª—É–∂–µ–Ω–æ</button>
                    </form>
                </div>
            </div>
        {% endfor %}
        <div style="padding:15px; text-align:right; background-color:#f8f9fa; border-top:2px solid #e74c3c;">
            <button type="button" id="bulk-serviced-urgent-btn" class="btn btn-danger" style="padding:8px 20px; font-size:14px; font-weight:bold;">
                ‚úÖ –û–±—Å–ª—É–∂–µ–Ω–æ –≤—Å—ë –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
            </button>
        </div>
    {% else %}
        <div class="section-title" style="color:#18bc9c;">
            –ù–µ—Ç —Å—Ä–æ—á–Ω—ã—Ö —Ä–∞–±–æ—Ç.
        </div>
    {% endif %}
</div>

<div class="card">
    {% if warning_items %}
        <div class="section-title" style="color:#f39c12;">
            ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è —Å—Ä–æ–∫ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è. (–∑–∞–ø–∏—Å–µ–π: {{ warning_items|length }} –∏–∑ {{ total_warning }})
        </div>
        <hr class="section-separator" style="background-color:#f39c12;">
        {% for item in warning_items %}
            <div style="background-color: {{ loop.cycle('#F9FCFF', '#ffffff') }}; margin-left:0; padding:10px 10px 10px 10px; position:relative;">
                {{ item.html|safe }}
                <div style="position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" class="equipment-checkbox warning-checkbox" 
                           data-sheet="{{ item.type }}" 
                           data-row-number="{{ item.row_number }}" 
                           style="width:18px; height:18px; cursor:pointer; accent-color: #f39c12;"
                           title="–í—ã–±—Ä–∞—Ç—å –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏">
                    <form method="post" action="{{ url_for('mark_serviced') }}" style="margin:0;" onsubmit="return confirm('–û—Ç–º–µ—Ç–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ¬´{{ item.designation }}¬ª –∫–∞–∫ –æ–±—Å–ª—É–∂–µ–Ω–Ω–æ–µ?');">
                        <input type="hidden" name="sheet_name" value="{{ item.type }}">
                        <input type="hidden" name="row_number" value="{{ item.row_number }}">
                        <input type="hidden" name="object" value="{{ object_filter }}">
                        <input type="hidden" name="status" value="{{ status_filter }}">
                        <input type="hidden" name="designation_filter" value="{{ designation_filter }}">
                        <button type="submit" class="btn btn-primary" style="padding:4px 12px; font-size:12px; background-color:#18bc9c; border:none;">‚úÖ –û–±—Å–ª—É–∂–µ–Ω–æ</button>
                    </form>
                </div>
            </div>
        {% endfor %}
        <div style="padding:15px; text-align:right; background-color:#f8f9fa; border-top:2px solid #f39c12;">
            <button type="button" id="bulk-serviced-warning-btn" class="btn btn-primary" style="padding:8px 20px; font-size:14px; font-weight:bold; background-color:#f39c12; border:none;">
                ‚úÖ –û–±—Å–ª—É–∂–µ–Ω–æ –≤—Å—ë –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
            </button>
        </div>
    {% else %}
        <div class="section-title">
            –ù–µ—Ç –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è —Ä–∞–±–æ—Ç.
        </div>
    {% endif %}
</div>

<div class="card" style="background-color:#ffffff; border-left:4px solid #18bc9c; font-size:11px; color:#333;">
    <div style="margin-bottom:8px;">
        <span style="font-weight:bold; color:#2c3e50;">
            üîß –°–∫—Ä–∏–ø—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ê–°–£–¢–ü
        </span>
        <span style="float:right; background-color:#18bc9c; color:white; padding:2px 8px; border-radius:10px; font-size:10px;">
            v{{ config.VERSION }} –æ—Ç {{ config.RELEASE_DATE }}<br/>semonoff@gmail.com
        </span>
    </div>
    <div style="clear:both;"></div>
    <div style="line-height:1.4;">
        <span style="color:#2c3e50;">üìÇ –§–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:</span><br/>
        <span style="margin-left:15px;">üìä –¢–∞–±–ª–∏—Ü–∞:</span>
        <code>{{ config.get_excel_file_path() }}</code><br/>
        <span style="margin-left:15px;">üêç –°–∫—Ä–∏–ø—Ç:</span>
        <code>{{ config.PROGRAM_DIR / 'maintenance_alert.py' }}</code><br/>
        <span>üìß –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ ({{ config.RECIPIENTS|length }}):</span>
        {{ config.RECIPIENTS | join(', ') }}
    </div>
</div>

<script>
// Bulk serviced action for selected equipment
(function() {
    const bulkUrgentBtn = document.getElementById('bulk-serviced-urgent-btn');
    const bulkWarningBtn = document.getElementById('bulk-serviced-warning-btn');
    
    function processBulkServiced(checkboxClass, listType) {
        const checkboxes = document.querySelectorAll('.' + checkboxClass + ':checked');
        
        if (checkboxes.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.');
            return;
        }
        
        const count = checkboxes.length;
        const confirmMsg = '–û—Ç–º–µ—Ç–∏—Ç—å ' + count + ' –µ–¥. –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∫–∞–∫ –æ–±—Å–ª—É–∂–µ–Ω–Ω–æ–µ?';
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        // Collect all selected items
        const items = [];
        checkboxes.forEach(function(checkbox) {
            items.push({
                sheet_name: checkbox.getAttribute('data-sheet'),
                row_number: checkbox.getAttribute('data-row-number')
            });
        });
        
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("mark_bulk_serviced") }}';
        
        // Add items as JSON
        const itemsInput = document.createElement('input');
        itemsInput.type = 'hidden';
        itemsInput.name = 'items';
        itemsInput.value = JSON.stringify(items);
        form.appendChild(itemsInput);
        
        // Preserve filters
        const objectInput = document.createElement('input');
        objectInput.type = 'hidden';
        objectInput.name = 'object';
        objectInput.value = '{{ object_filter }}';
        form.appendChild(objectInput);
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = '{{ status_filter }}';
        form.appendChild(statusInput);
        
        const designationInput = document.createElement('input');
        designationInput.type = 'hidden';
        designationInput.name = 'designation_filter';
        designationInput.value = '{{ designation_filter }}';
        form.appendChild(designationInput);
        
        document.body.appendChild(form);
        form.submit();
    }
    
    if (bulkUrgentBtn) {
        bulkUrgentBtn.addEventListener('click', function() {
            processBulkServiced('urgent-checkbox', '—Å—Ä–æ—á–Ω–æ–µ');
        });
    }
    
    if (bulkWarningBtn) {
        bulkWarningBtn.addEventListener('click', function() {
            processBulkServiced('warning-checkbox', '–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ');
        });
    }
})();
</script>

{% endblock %}
